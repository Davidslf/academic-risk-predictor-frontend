---
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
---

<!doctype html>
<html lang="es">
    <head>
        <BaseHead
            title="Realizar Predicci√≥n | Predictor de Riesgo Acad√©mico"
            description="Analiza tu riesgo acad√©mico con nuestro sistema de Machine Learning"
        />

        <!-- Bootstrap 5 -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <!-- Bootstrap Icons -->
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
        />
        <!-- Chart.js -->
        <script
            src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"
        ></script>
        <!-- KaTeX -->
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
        />
        <script
            defer
            src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"
        ></script>

        <style>
            html, body {
                margin: 0;
                padding: 0;
            }

            body {
                background: linear-gradient(135deg, #f6f8fb 0%, #e9ecef 100%);
                min-height: 100vh;
            }

            .form-card,
            .result-card {
                border: none;
                border-radius: 15px;
                box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
                background: white;
                padding: 30px;
                margin-bottom: 30px;
            }

            .form-label {
                font-weight: 600;
                color: #495057;
                margin-bottom: 10px;
            }

            .slider-value {
                display: inline-block;
                background: linear-gradient(135deg, #004b93 0%, #003a75 100%);
                color: white;
                padding: 5px 15px;
                border-radius: 20px;
                font-weight: 600;
                min-width: 60px;
                text-align: center;
            }

            .form-range::-webkit-slider-thumb {
                background: linear-gradient(135deg, #004b93 0%, #003a75 100%);
            }

            .form-range::-moz-range-thumb {
                background: linear-gradient(135deg, #004b93 0%, #003a75 100%);
            }

            .btn-analyze {
                background: linear-gradient(135deg, #ffc72c 0%, #e6b800 100%);
                border: none;
                padding: 15px 40px;
                font-size: 1.1rem;
                font-weight: 600;
                border-radius: 50px;
                color: #003a75;
                box-shadow: 0 4px 15px rgba(255, 199, 44, 0.4);
                transition: all 0.3s ease;
            }

            .btn-analyze:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(255, 199, 44, 0.6);
            }

            .risk-badge {
                display: inline-block;
                padding: 10px 30px;
                border-radius: 50px;
                font-weight: 700;
                font-size: 1.2rem;
            }

            .risk-bajo {
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                color: white;
            }

            .risk-medio {
                background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                color: white;
            }

            .risk-alto {
                background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
                color: white;
            }

            .chart-container {
                position: relative;
                height: 300px;
                margin: 20px 0;
            }

            .gauge-container {
                position: relative;
                height: 250px;
                margin: 20px auto;
                max-width: 400px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .gauge-container canvas {
                max-width: 100%;
                height: auto !important;
            }

            /* Chatbot Styles */
            .chatbot-container {
                position: fixed;
                bottom: 30px;
                right: 30px;
                width: 380px;
                max-height: 600px;
                background: white;
                border-radius: 20px;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
                z-index: 1000;
                display: none;
                flex-direction: column;
                overflow: hidden;
            }

            .chatbot-container.show {
                display: flex;
            }

            .chatbot-header {
                background: linear-gradient(135deg, #004b93 0%, #003a75 100%);
                color: white;
                padding: 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .chatbot-messages {
                flex: 1;
                padding: 20px;
                overflow-y: auto;
                max-height: 400px;
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .chat-message {
                padding: 12px 16px;
                border-radius: 15px;
                max-width: 80%;
                word-wrap: break-word;
                clear: both;
                position: relative;
            }

            .chat-message.bot {
                background: #f0f0f0;
                color: #000;
                align-self: flex-start;
                border-bottom-left-radius: 4px;
            }

            .chat-message.user {
                background: linear-gradient(135deg, #004b93 0%, #003a75 100%);
                color: white;
                align-self: flex-end;
                border-bottom-right-radius: 4px;
            }

            .chatbot-input {
                display: flex;
                padding: 15px;
                border-top: 1px solid #e0e0e0;
            }

            .chat-toggle-btn {
                position: fixed;
                bottom: 30px;
                right: 30px;
                width: 60px;
                height: 60px;
                border-radius: 50%;
                background: linear-gradient(135deg, #ffc72c 0%, #e6b800 100%);
                color: #003a75;
                border: none;
                font-size: 1.5rem;
                box-shadow: 0 4px 15px rgba(255, 199, 44, 0.4);
                cursor: pointer;
                z-index: 999;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.3s ease;
            }

            .chat-toggle-btn:hover {
                transform: scale(1.1);
                box-shadow: 0 6px 20px rgba(255, 199, 44, 0.6);
            }

            .spinner-border-custom {
                width: 3rem;
                height: 3rem;
                border-width: 0.3rem;
            }

            /* Sticky behavior para desktop */
            @media (min-width: 992px) {
                .form-card.sticky-top {
                    position: sticky;
                    top: 20px;
                    z-index: 100;
                }
            }

            /* En m√≥vil, desactivar sticky */
            @media (max-width: 991px) {
                .form-card.sticky-top {
                    position: relative;
                    top: auto !important;
                }
            }

            @media (max-width: 768px) {
                .chatbot-container {
                    width: calc(100% - 40px);
                    right: 20px;
                    left: 20px;
                }
            }
        </style>
    </head>

    <body>
        <Header />
        
        <main class="container py-5">
            <!-- Header -->
            <div class="text-center mb-5">
                <h1 class="display-4 fw-bold mb-3">
                    <i class="bi bi-graph-up-arrow text-primary"></i>
                    Predicci√≥n de Riesgo Acad√©mico
                </h1>
                <p class="lead text-muted">
                    Ingresa tus datos y obt√©n un an√°lisis completo con gr√°ficas
                    y recomendaciones
                </p>
            </div>

            <div class="row">
                <!-- Formulario -->
                <div class="col-lg-5 mb-4">
                    <div class="form-card sticky-top">
                        <h4 class="fw-bold mb-4">
                            <i class="bi bi-person-circle text-primary"></i>
                            Tus Datos Acad√©micos
                        </h4>

                        <form id="prediction-form">
                            <!-- Asistencia -->
                            <div class="mb-4">
                                <label
                                    class="form-label d-flex justify-content-between"
                                >
                                    <span
                                        ><i
                                            class="bi bi-calendar-check text-success"
                                        ></i> Promedio de Asistencia</span
                                    >
                                    <span
                                        class="slider-value"
                                        id="asistencia-value">85%</span
                                    >
                                </label>
                                <input
                                    type="range"
                                    class="form-range"
                                    id="asistencia"
                                    min="0"
                                    max="100"
                                    value="85"
                                    step="0.1"
                                />
                                <div
                                    class="d-flex justify-content-between small text-muted"
                                >
                                    <span>0%</span>
                                    <span>100%</span>
                                </div>
                            </div>

                            <!-- Seguimiento -->
                            <div class="mb-4">
                                <label
                                    class="form-label d-flex justify-content-between"
                                >
                                    <span
                                        ><i
                                            class="bi bi-clipboard-data text-info"
                                        ></i> Promedio de Seguimiento</span
                                    >
                                    <span
                                        class="slider-value"
                                        id="seguimiento-value">3.5</span
                                    >
                                </label>
                                <input
                                    type="range"
                                    class="form-range"
                                    id="seguimiento"
                                    min="0"
                                    max="5"
                                    value="3.5"
                                    step="0.1"
                                />
                                <div
                                    class="d-flex justify-content-between small text-muted"
                                >
                                    <span>0.0</span>
                                    <span>5.0</span>
                                </div>
                            </div>

                            <!-- Nota Parcial -->
                            <div class="mb-4">
                                <label
                                    class="form-label d-flex justify-content-between"
                                >
                                    <span
                                        ><i
                                            class="bi bi-file-earmark-text text-warning"
                                        ></i> Nota Parcial 1</span
                                    >
                                    <span
                                        class="slider-value"
                                        id="parcial-value">3.2</span
                                    >
                                </label>
                                <input
                                    type="range"
                                    class="form-range"
                                    id="parcial"
                                    min="0"
                                    max="5"
                                    value="3.2"
                                    step="0.1"
                                />
                                <div
                                    class="d-flex justify-content-between small text-muted"
                                >
                                    <span>0.0</span>
                                    <span>5.0</span>
                                </div>
                            </div>

                            <!-- Logins -->
                            <div class="mb-4">
                                <label
                                    class="form-label d-flex justify-content-between"
                                >
                                    <span
                                        ><i class="bi bi-laptop text-primary"
                                        ></i> Inicios de Sesi√≥n</span
                                    >
                                    <span class="slider-value" id="logins-value"
                                        >42</span
                                    >
                                </label>
                                <input
                                    type="range"
                                    class="form-range"
                                    id="logins"
                                    min="0"
                                    max="100"
                                    value="42"
                                    step="1"
                                />
                                <div
                                    class="d-flex justify-content-between small text-muted"
                                >
                                    <span>0</span>
                                    <span>100</span>
                                </div>
                            </div>

                            <!-- Tutor√≠as -->
                            <div class="mb-4">
                                <label class="form-label">
                                    <i class="bi bi-person-video3 text-danger"
                                    ></i> Uso de Tutor√≠as
                                </label>
                                <div class="form-check form-switch">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        id="tutorias"
                                        checked
                                        style="width: 3em; height: 1.5em;"
                                    />
                                    <label
                                        class="form-check-label ms-2"
                                        for="tutorias"
                                    >
                                        <span id="tutorias-label"
                                            >S√≠, uso tutor√≠as</span
                                        >
                                    </label>
                                </div>
                            </div>

                            <!-- Bot√≥n -->
                            <button
                                type="submit"
                                class="btn btn-analyze w-100 mt-3"
                            >
                                <i class="bi bi-stars me-2"></i>
                                Analizar Mi Riesgo Acad√©mico
                            </button>
                        </form>

                        <div
                            id="loading"
                            class="text-center mt-4"
                            style="display: none;"
                        >
                            <div
                                class="spinner-border spinner-border-custom text-primary"
                                role="status"
                            >
                                <span class="visually-hidden"
                                    >Analizando...</span
                                >
                            </div>
                            <p class="mt-3 text-muted">
                                Analizando tus datos...
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Resultados -->
                <div class="col-lg-7">
                    <!-- Mensaje inicial -->
                    <div
                        id="initial-message"
                        class="result-card text-center py-5"
                    >
                        <i
                            class="bi bi-graph-up"
                            style="font-size: 5rem; color: #dee2e6;"></i>
                        <h4 class="mt-3 text-muted">Esperando tus datos...</h4>
                        <p class="text-muted">
                            Completa el formulario y presiona "Analizar" para
                            ver los resultados
                        </p>
                    </div>

                    <!-- Contenedor de resultados -->
                    <div id="results-container" style="display: none;">
                        <!-- Nivel de Riesgo con Veloc√≠metro -->
                        <div class="result-card text-center">
                            <h4 class="fw-bold mb-4">
                                <i class="bi bi-exclamation-triangle"></i> Nivel
                                de Riesgo
                            </h4>

                            <!-- Veloc√≠metro -->
                            <div class="gauge-container mb-4">
                                <canvas id="gauge-chart"></canvas>
                            </div>

                            <div id="risk-badge" class="mt-3"></div>

                            <!-- Probabilidad de Aprobar -->
                            <div class="mt-4 p-3 bg-light rounded">
                                <h5 class="fw-bold text-success mb-2">
                                    <i class="bi bi-trophy-fill"></i> Probabilidad
                                    de Aprobar
                                </h5>
                                <div
                                    style="font-size: 2.5rem; font-weight: 700; color: #10b981;"
                                    id="prob-aprobar"
                                >
                                    0%
                                </div>
                            </div>
                        </div>

                        <!-- Gr√°fico de Barras Comparativo -->
                        <div class="result-card">
                            <h5 class="fw-bold mb-3">
                                <i class="bi bi-bar-chart"></i> Asistencia a la plataforma
                            </h5>
                            <div class="chart-container" style="height: 350px;">
                                <canvas id="bar-chart"></canvas>
                            </div>
                        </div>

                        <!-- Gr√°fico de Notas -->
                        <div class="result-card">
                            <h5 class="fw-bold mb-3">
                                <i class="bi bi-journal-text"></i> Seguimiento y Notas
                            </h5>
                            <div class="chart-container" style="height: 350px;">
                                <canvas id="notes-chart"></canvas>
                            </div>
                        </div>

                        <!-- Gr√°fico de Asistencia -->
                        <div class="result-card">
                            <h5 class="fw-bold mb-3">
                                <i class="bi bi-calendar-check"></i> Asistencia
                            </h5>
                            <div class="chart-container" style="height: 350px;">
                                <canvas id="attendance-chart"></canvas>
                            </div>
                        </div>

                        <!-- An√°lisis IA -->
                        <div class="result-card">
                            <h5 class="fw-bold mb-3">
                                <i class="bi bi-chat-left-quote"></i> An√°lisis y
                                Recomendaciones
                            </h5>
                            <div id="ia-analysis" class=""></div>
                        </div>

                        <!-- Bot√≥n Detalles Matem√°ticos -->
                        <button
                            class="btn btn-lg btn-outline-primary w-100"
                            id="show-math-btn"
                        >
                            <i class="bi bi-calculator"></i>
                            Ver Detalles Matem√°ticos Completos
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Modal Matem√°tico (Aqu√≠ ir√≠a todo el modal HTML - mantengo el original) -->
        <div class="modal fade" id="mathModal" tabindex="-1">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="bi bi-calculator"></i>
                            Detalles Matem√°ticos de la Predicci√≥n
                        </h5>
                        <button
                            type="button"
                            class="btn-close btn-close-white"
                            data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info mb-4">
                            <h6 class="fw-bold mb-2">
                                <i class="bi bi-info-circle"></i> ¬øC√≥mo funciona
                                el modelo?
                            </h6>
                            <p class="mb-0 small">
                                Este sistema utiliza <strong
                                    >Regresi√≥n Log√≠stica</strong
                                >, un algoritmo de Machine Learning que calcula
                                la probabilidad de que un estudiante repruebe
                                bas√°ndose en sus datos acad√©micos.
                            </p>
                        </div>

                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="bi bi-calculator"></i> F√≥rmulas del
                                    Modelo
                                </h6>
                            </div>
                            <div class="card-body">
                                <p class="small text-muted mb-2">
                                    <strong>1. C√°lculo del Logit (z):</strong>
                                </p>
                                <div
                                    id="formula-logit"
                                    class="p-3 bg-light rounded text-center mb-3"
                                >
                                </div>

                                <p class="small text-muted mb-2 mt-4">
                                    <strong
                                        >2. Funci√≥n Sigmoide (Probabilidad):</strong
                                    >
                                </p>
                                <div
                                    id="formula-sigmoide"
                                    class="p-3 bg-light rounded text-center"
                                >
                                </div>
                            </div>
                        </div>

                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="bi bi-table"></i> C√°lculo Paso a Paso
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Variable</th>
                                                <th class="text-center"
                                                    >Valor Escalado (x·µ¢)</th
                                                >
                                                <th class="text-center"
                                                    >Coeficiente (Œ≤·µ¢)</th
                                                >
                                                <th class="text-center"
                                                    >Impacto (x·µ¢ √ó Œ≤·µ¢)</th
                                                >
                                            </tr>
                                        </thead>
                                        <tbody id="math-table-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="bi bi-123"></i> C√°lculos Finales
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <small class="text-muted"
                                        >Intercepto (Œ≤‚ÇÄ):</small
                                    >
                                    <div
                                        class="bg-light p-2 rounded font-monospace"
                                        id="intercepto-value"
                                    >
                                        0.0000
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <small class="text-muted"
                                        >C√°lculo de z (logit):</small
                                    >
                                    <div
                                        class="bg-light p-2 rounded font-monospace small"
                                        id="calculo-logit"
                                    >
                                        z = ...
                                    </div>
                                </div>
                                <div>
                                    <small class="text-muted"
                                        >C√°lculo de Probabilidad:</small
                                    >
                                    <div
                                        class="bg-light p-2 rounded font-monospace small"
                                        id="calculo-probabilidad"
                                    >
                                        P = ...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chatbot -->
        <button class="chat-toggle-btn" id="chat-toggle">
            <i class="bi bi-chat-dots"></i>
        </button>

        <div class="chatbot-container" id="chatbot">
            <div class="chatbot-header">
                <div>
                    <h6 class="mb-0">
                        <i class="bi bi-robot"></i> Consejero Virtual
                    </h6>
                    <small class="opacity-75"
                        >Preg√∫ntame sobre tu rendimiento</small
                    >
                </div>
                <button class="btn btn-sm btn-light" id="chat-close">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="chatbot-messages" id="chat-messages">
                <div class="chat-message bot">
                    ¬°Hola! üëã Soy tu consejero acad√©mico virtual. Puedo ayudarte
                    con preguntas sobre tu rendimiento y darte consejos
                    personalizados.
                </div>
            </div>
            <div class="chatbot-input">
                <input
                    type="text"
                    class="form-control"
                    id="chat-input"
                    placeholder="Escribe tu pregunta..."
                />
                <button class="btn btn-primary ms-2" id="chat-send">
                    <i class="bi bi-send"></i>
                </button>
            </div>
        </div>

        <Footer />

        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        ></script>
        
        <!-- ‚≠ê C√ìDIGO REFACTORIZADO CON SOLID Y CLEAN CODE ‚≠ê -->
        <script>
            /**
             * Aplicaci√≥n refactorizada con arquitectura limpia
             * - C√≥digo modularizado en archivos TypeScript separados
             * - Debugging completo con breakpoints funcionales
             * - Principios SOLID aplicados
             * - Responsabilidad √önica por m√≥dulo
             * - F√°cil mantenimiento y testing
             */
            import { appController } from '../../app/app.controller';

            // Inicializar la aplicaci√≥n cuando el DOM est√© listo
            appController.initialize();
        </script>
    </body>
</html>

